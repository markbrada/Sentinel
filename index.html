<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IAM Sentinel – Lead Dashboard</title>

  <!-- TailwindCSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config={darkMode:'class'}</script>

  <!-- jQuery & DataTables -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css"/>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <!-- DataTables Buttons (PDF export) -->
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css"/>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>

  <!-- Feather icons -->
  <script src="https://unpkg.com/feather-icons"></script>

  <style>
    /* Override DataTables colours for dark mode */
    html.dark table.dataTable tbody tr { background-color:#1f2937; color:#d1d5db; }
    html.dark table.dataTable thead { background-color:#374151; color:white; }
    html.dark table.dataTable { border-color:#4b5563; }
  </style>
</head>
<body class="flex h-screen bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
  <!-- ============= Sidebar ============= -->
  <aside id="sidebar" class="w-64 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 flex flex-col p-4 space-y-6">
    <!-- Brand + collapse btn -->
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l4 2"/></svg>
        <span class="font-semibold">IAM&nbsp;Sentinel</span>
      </div>
      <button id="toggle-dark" class="p-1 rounded hover:bg-gray-100 dark:hover:bg-gray-700"><i data-feather="moon"></i></button>
    </div>

    <!-- Filters -->
    <div>
      <h2 class="font-semibold mb-2">Filters</h2>
      <label class="block text-sm mb-1" for="regionSelect">Region</label>
      <select id="regionSelect" multiple class="w-full rounded border-gray-300 dark:bg-gray-700 dark:border-gray-600 mb-4"></select>

      <label class="block text-sm mb-1" for="typeSelect">Provider Type</label>
      <select id="typeSelect" multiple class="w-full rounded border-gray-300 dark:bg-gray-700 dark:border-gray-600 mb-4">
        <option>Support At Home Program Provider</option>
        <option>NDIS</option>
        <option>Other</option>
      </select>

      <label class="block text-sm mb-1" for="searchInput">Search</label>
      <input id="searchInput" type="search" placeholder="Name / rationale…" class="w-full rounded border-gray-300 dark:bg-gray-700 dark:border-gray-600"/>
      <button id="resetBtn" class="mt-3 w-full px-3 py-2 rounded bg-gray-200 dark:bg-gray-700 text-sm">Reset</button>
    </div>

    <div class="mt-auto text-xs opacity-70">© 2025 In A Minnit</div>
  </aside>

  <!-- ============= Main content ============= -->
  <main class="flex-1 overflow-y-auto p-6 space-y-10">

    <!-- KPI tiles -->
    <section class="grid grid-cols-1 sm:grid-cols-3 gap-4">
      <div class="p-4 rounded bg-blue-500/10 dark:bg-blue-400/20">
        <div class="text-sm">New Clients</div>
        <div id="kpiClients" class="text-3xl font-semibold">–</div>
      </div>
      <div class="p-4 rounded bg-amber-500/10 dark:bg-amber-400/20">
        <div class="text-sm">Tenders ≤ 14 days</div>
        <div id="kpiTenders" class="text-3xl font-semibold">–</div>
      </div>
      <div class="p-4 rounded bg-purple-500/10 dark:bg-purple-400/20">
        <div class="text-sm">OT Practices</div>
        <div id="kpiOT" class="text-3xl font-semibold">–</div>
      </div>
    </section>

    <!-- Sections -->
    <section>
      <h2 class="font-semibold text-lg mb-3">New Potential Clients</h2>
      <table id="clientTable" class="display w-full"></table>
    </section>

    <section>
      <h2 class="font-semibold text-lg mb-3">Tender Opportunities</h2>
      <table id="tenderTable" class="display w-full"></table>
    </section>

    <section class="pb-10">
      <h2 class="font-semibold text-lg mb-3">OT Practices</h2>
      <table id="otTable" class="display w-full"></table>
    </section>
  </main>

  <!-- ============= Script ============= -->
  <script>
    feather.replace();

    /* Dark mode persistence */
    const root=document.documentElement; const darkPref=localStorage.getItem('iam-dark'); if(darkPref==='true') root.classList.add('dark');
    document.getElementById('toggle-dark').onclick=()=>{root.classList.toggle('dark'); localStorage.setItem('iam-dark',root.classList.contains('dark'))};

    /* Helper to parse states */
    const extractStates=str=>str.match(/[A-Z]{2,3}/g)||[];

    /* Load data.json */
    fetch('data.json').then(r=>r.json()).then(data=>{
      const clients=data.NewPotentialClients; const tenders=data.TenderOpportunities; const ots=data.OTPractices;

      /* KPI counts */
      $('#kpiClients').text(clients.length);
      $('#kpiOT').text(ots.length);
      const soon=tenders.filter(t=>{const diff=(new Date(t.CloseDate)-Date.now())/864e5; return diff<=14}).length; $('#kpiTenders').text(soon);

      /* Populate region filter */
      const regionSet=new Set(); clients.forEach(c=>extractStates(c.Region).forEach(s=>regionSet.add(s))); regionSet.forEach(s=>$('#regionSelect').append(`<option>${s}</option>`));

      /* Build DataTables */
      const clientTable=$('#clientTable').DataTable({
        data:clients,
        dom:'Bfrtip',
        buttons:['pdfHtml5'],
        columns:[
          {title:'Provider',data:'ProviderName'},
          {title:'Type',data:'Type'},
          {title:'Region',data:'Region'},
          {title:'Est. Clients',data:'EstimatedClients'},
          {title:'Decision Maker',data:null,render:d=>`${d.DecisionMaker.Name}<br><span class='text-xs opacity-70'>${d.DecisionMaker.Title}</span>`},
          {title:'Contact',data:null,orderable:false,render:d=>{
            const tel=d.DecisionMaker.Phone?`<a href='tel:${d.DecisionMaker.Phone.replace(/\s/g,'')}' class='mr-1 underline'>📞</a>`:'';
            const mail=d.DecisionMaker.Email?`<a href='mailto:${d.DecisionMaker.Email}' class='mr-1 underline'>✉️</a>`:'';
            const li=d.DecisionMaker.LinkedIn?`<a href='${d.DecisionMaker.LinkedIn}' target='_blank' class='underline'>in</a>`:'';
            return tel+mail+li;
          }},
          {title:'Rationale',data:'Rationale'},
          {title:'Sources',data:'Sources',orderable:false,render:a=>a.map((u,i)=>`<a href='${u}' target='_blank' class='underline'>[${i+1}]</a>`).join(' ')}
        ]
      });

      const tenderTable=$('#tenderTable').DataTable({
        data:tenders,
        dom:'Bfrtip',buttons:['pdfHtml5'],
        columns:[
          {title:'Title',data:'Title'},
          {title:'Buyer',data:'Buyer'},
          {title:'Close',data:'CloseDate'},
          {title:'Category',data:'Relevance'},
          {title:'Link',data:'Link',render:u=>`<a href='${u}' target='_blank' class='underline'>open</a>`},
          {title:'Sources',data:'Sources',render:a=>a.map((u,i)=>`<a href='${u}' target='_blank' class='underline'>[${i+1}]</a>`).join(' ')}
        ]
      });

      const otTable=$('#otTable').DataTable({
        data:ots,
        dom:'Bfrtip',buttons:['pdfHtml5'],
        columns:[
          {title:'Practice',data:'PracticeName'},
          {title:'Region',data:'Region'},
          {title:'OTs',data:'OTCount'},
          {title:'Email',data:'Contact.Email',render:e=>e?`<a href='mailto:${e}' class='underline'>${e}</a>`:''},
          {title:'Phone',data:'Contact.Phone'},
          {title:'Sources',data:'Sources',render:a=>a.map((u,i)=>`<a href='${u}' target='_blank' class='underline'>[${i+1}]</a>`).join(' ')}
        ]
      });

      /* External filter logic */
      const applyFilters=()=>{
        const regions=$('#regionSelect').val()||[]; const types=$('#typeSelect').val()||[]; const search=$('#searchInput').val().toLowerCase();
        clientTable.draw(); // triggers the search plugin below
      };
      $.fn.dataTable.ext.search.push((settings,data,idx,row)=>{
        if(settings.nTable.id!=='clientTable') return true; // only clients
        const regions=$('#regionSelect').val()||[]; const types=$('#typeSelect').val()||[]; const search=$('#searchInput').val().toLowerCase();
        const regionOk=!regions.length||regions.some(r=>row.Region.includes(r));
        const typeOk=!types.length||types.includes(row.Type);
        const searchOk=!search||row.ProviderName.toLowerCase().includes(search)||row.Rationale.toLowerCase().includes(search);
        return regionOk&&typeOk&&searchOk;
      });
      $('#regionSelect,#typeSelect').on('change',applyFilters); $('#searchInput').on('input',applyFilters);
      $('#resetBtn').on('click',()=>{$('#regionSelect option:selected,#typeSelect option:selected').prop('selected',false);$('#searchInput').val('');applyFilters();});
    });
  </script>
</body>
</html>
